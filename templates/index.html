<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IceJam U15 AAA</title>

<style>
body { margin:0; font-family:-apple-system, BlinkMacSystemFont, sans-serif; background:#0b0f17; color:#fff; }
.container { max-width:720px; margin:auto; padding:16px; }
h1 { margin:0; font-size:22px; }
.card { background:#121a2a; border-radius:14px; padding:16px; margin-top:12px; }
.card-title { font-size:14px; font-weight:600; margin-bottom:12px; color:#4da3ff; }
button,select { width:100%; padding:14px; font-size:16px; border-radius:12px; border:none; box-sizing:border-box; }
select { background:#1a2538; color:#fff; margin-bottom:8px; -webkit-appearance:none; cursor:pointer; }
select option { background:#1a2538; color:#fff; }
button { background:#1e8e3e; font-weight:700; margin-top:10px; cursor:pointer; color:#fff; }
button:active { background:#167a2e; }
.row { display:flex; gap:8px; }
.row > * { flex:1; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { padding:8px; border-bottom:1px solid #2a3350; font-size:14px; text-align:left; }
th { color:#9fb0cf; font-weight:500; }
.hitmen { background:#1e8e3e33; font-weight:700; }
.small { color:#9fb0cf; font-size:12px; }
.msg { padding:12px; border-radius:8px; margin-top:10px; font-size:14px; }
.msg.success { background:#1e8e3e33; color:#4ade80; }
.msg.error { background:#dc354533; color:#f87171; }
.msg.info { background:#4da3ff22; color:#4da3ff; }
.header { display:flex; justify-content:space-between; align-items:center; }
.header-links { display:flex; gap:8px; }
.header-links a { background:#2a3350; color:#fff; padding:8px 14px; border-radius:8px; text-decoration:none; font-size:13px; font-weight:600; }
.live-badge { display:inline-block; background:#1e8e3e; color:#fff; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:6px; }
#live-result { margin-top:12px; }
#live-result table { font-size:13px; }
.toggle-row { display:flex; gap:8px; margin-top:8px; }
.toggle-btn { flex:1; padding:10px; text-align:center; background:#1a2538; border-radius:8px; cursor:pointer; font-size:14px; border:none; color:#fff; }
.toggle-btn.active { background:#28a745; }
.rules-toggle { display:flex; align-items:center; gap:8px; font-size:14px; padding:8px 12px; background:#1a2538; border-radius:8px; margin-top:8px; }
.rules-toggle input { width:auto; }
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <div>
      <h1>IceJam U15 AAA</h1>
      <div class="small">Eastern Hitmen Standings Tracker</div>
    </div>
    <div class="header-links">
      <a href="/rules">Rules</a>
    </div>
  </div>

  <!-- Live Standings -->
  <div class="card">
    <div class="card-title">Live Standings <span class="live-badge">LIVE</span></div>

    <select id="track-team" onchange="highlightTracked()">
      <option value="">-- Select Team to Track --</option>
    </select>

    <div id="tracked-info" class="msg info" style="display:none;"></div>

    <button onclick="fetchLive()">Refresh Standings</button>

    <div class="toggle-row">
      <button id="btn-overview" class="toggle-btn active" onclick="setView('overview')">Overview</button>
      <button id="btn-offence" class="toggle-btn" onclick="setView('offence')">Offence</button>
    </div>

    <label class="rules-toggle">
      <input type="checkbox" id="apply-rules" checked onchange="toggleRules()">
      <span id="rules-label">Apply Tournament Tiebreaker Rules</span>
    </label>

    <div id="live-status"></div>
    <div id="live-result"></div>
  </div>

  <!-- Schedule -->
  <div class="card">
    <div class="card-title">Schedule</div>
    <button onclick="fetchSchedule()">Fetch Schedule</button>
    <div id="schedule-result">
      <div class="small" style="margin-top:10px;">Tap button to load schedule</div>
    </div>
  </div>

  <!-- Scores -->
  <div class="card">
    <div class="card-title">Game Scores</div>
    <button onclick="fetchScores()">Fetch Scores</button>
    <div id="scores-result">
      <div class="small" style="margin-top:10px;">Tap button to load game scores</div>
    </div>
  </div>

  <!-- Playoff Matchups -->
  <div class="card">
    <div class="card-title">Playoff Matchups</div>
    <button onclick="fetchPlayoffBracket()" style="background:#6366f1;">Show Playoff Bracket</button>
    <div id="bracket-result">
      <div class="small" style="margin-top:10px;">See projected Round of 16 matchups based on current standings</div>
    </div>
  </div>

  <!-- AI Analysis -->
  <div class="card">
    <div class="card-title">AI Analysis</div>
    <button onclick="fetchAIAnalysis()" style="background:#4da3ff;">Get AI Insights</button>
    <div id="ai-result">
      <div class="small" style="margin-top:10px;">Get AI-powered analysis of your team's playoff situation</div>
    </div>
  </div>
</div>

<script>
let liveStandings = [];
let liveTiebreakers = [];
let currentView = 'overview';
let applyRules = true;

function toggleRules() {
  applyRules = document.getElementById('apply-rules').checked;
  const label = document.getElementById('rules-label');
  if (applyRules) {
    label.textContent = 'Apply Tournament Tiebreaker Rules';
    label.style.color = '#4ade80';
  } else {
    label.textContent = 'Using icejam.ca default order';
    label.style.color = '#f87171';
  }
  if (liveStandings.length > 0) {
    fetchLive();
  }
}

function setView(view) {
  currentView = view;
  document.getElementById('btn-overview').classList.toggle('active', view === 'overview');
  document.getElementById('btn-offence').classList.toggle('active', view === 'offence');
  if (liveStandings.length > 0) {
    renderStandingsTable();
  }
}

function renderStandingsTable() {
  const result = document.getElementById("live-result");
  let html = '';

  if (currentView === 'overview') {
    html = '<table><thead><tr><th>#</th><th>Team</th><th>GP</th><th>W</th><th>L</th><th>OTL</th><th>PTS</th><th>GF</th><th>GA</th></tr></thead><tbody>';
    liveStandings.forEach((t, i) => {
      html += `<tr data-team="${t.team}">
        <td>${i+1}</td>
        <td>${t.team}</td>
        <td>${t.gp}</td>
        <td>${t.w}</td>
        <td>${t.l}</td>
        <td>${t.otl}</td>
        <td><b>${t.pts}</b></td>
        <td>${t.gf}</td>
        <td>${t.ga}</td>
      </tr>`;
    });
  } else {
    html = '<table><thead><tr><th>#</th><th>Team</th><th>GP</th><th>PTS</th><th>PP%</th><th>PK%</th><th>PPG</th><th>SHG</th></tr></thead><tbody>';
    liveStandings.forEach((t, i) => {
      const ppPct = t.pp_per ? (t.pp_per * 100).toFixed(1) + '%' : '-';
      const pkPct = t.pk_per ? (t.pk_per * 100).toFixed(1) + '%' : '-';
      html += `<tr data-team="${t.team}">
        <td>${i+1}</td>
        <td>${t.team}</td>
        <td>${t.gp}</td>
        <td><b>${t.pts}</b></td>
        <td>${ppPct}</td>
        <td>${pkPct}</td>
        <td>${t.ppg || 0}</td>
        <td>${t.shg || 0}</td>
      </tr>`;
    });
  }
  html += '</tbody></table>';
  result.innerHTML = html;

  // Show tiebreaker calculations if any
  if (liveTiebreakers.length > 0) {
    let tbHtml = '<details style="margin-top:12px;"><summary style="cursor:pointer;color:#4da3ff;font-size:13px;">Tiebreaker Calculations (' + liveTiebreakers.length + ')</summary>';
    tbHtml += '<div style="background:#1a2538;padding:10px;margin-top:5px;border-radius:8px;font-size:12px;">';
    liveTiebreakers.forEach((tb, i) => {
      const color = tb.includes('TB1') ? '#4ade80' : (tb.includes('TIED') ? '#f87171' : '#9fb0cf');
      tbHtml += `<div style="margin:3px 0;color:${color};">${i+1}. ${tb}</div>`;
    });
    tbHtml += '</div></details>';
    result.innerHTML += tbHtml;
  }

  highlightTracked();
}

function populateTeamDropdown(standings) {
  const select = document.getElementById("track-team");
  const currentValue = select.value;

  select.innerHTML = '<option value="">-- Select Team to Track --</option>';

  standings.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t.team;
    opt.textContent = t.team;
    if (t.team.toLowerCase().includes('hitman') || t.team.toLowerCase().includes('hitmen')) {
      opt.selected = true;
    }
    select.appendChild(opt);
  });

  if (currentValue && standings.some(t => t.team === currentValue)) {
    select.value = currentValue;
  }
}

function highlightTracked() {
  const tracked = document.getElementById("track-team").value;
  const infoDiv = document.getElementById("tracked-info");

  document.querySelectorAll('#live-result tr').forEach(tr => {
    tr.classList.remove('hitmen');
  });

  if (!tracked || !liveStandings.length) {
    infoDiv.style.display = 'none';
    return;
  }

  let teamData = null;
  let rank = 0;
  liveStandings.forEach((t, i) => {
    if (t.team === tracked) {
      teamData = t;
      rank = i + 1;
    }
  });

  if (teamData) {
    document.querySelectorAll('#live-result tr').forEach(tr => {
      if (tr.dataset.team === tracked) {
        tr.classList.add('hitmen');
      }
    });

    const total = liveStandings.length;
    const gd = teamData.gf - teamData.ga;
    const gdStr = gd >= 0 ? `+${gd}` : `${gd}`;

    infoDiv.innerHTML = `<b>#${rank} of ${total}</b> | ${teamData.w}-${teamData.l}-${teamData.otl || 0} | ${teamData.pts} pts | GD: ${gdStr}`;
    infoDiv.style.display = 'block';
  } else {
    infoDiv.style.display = 'none';
  }
}

async function fetchLive() {
  const status = document.getElementById("live-status");
  const result = document.getElementById("live-result");

  status.innerHTML = '<div class="msg info">Fetching from icejam.ca...</div>';
  result.innerHTML = '';

  try {
    const r = await fetch(`/api/scrape?apply_rules=${applyRules}`);
    const d = await r.json();

    if (d.ok && d.standings && d.standings.length > 0) {
      liveStandings = d.standings;
      liveTiebreakers = d.tiebreaker_log || [];

      const seasonInfo = d.season ? `${d.season}/${parseInt(d.season)+1}` : '';
      const rulesInfo = d.tiebreakers_applied ? ' | Rules Applied' : '';
      const gamesInfo = d.games_used ? ` | ${d.games_used} games` : '';

      status.innerHTML = `<div class="msg success">${d.teams_found} teams | ${seasonInfo}${rulesInfo}${gamesInfo}</div>`;

      populateTeamDropdown(d.standings);
      renderStandingsTable();
    } else {
      status.innerHTML = `<div class="msg error">${d.error || 'No standings data found'}</div>`;
    }
  } catch (e) {
    status.innerHTML = `<div class="msg error">Network error: ${e.message}</div>`;
  }
}

async function fetchSchedule() {
  const result = document.getElementById("schedule-result");
  const tracked = document.getElementById("track-team").value || "Eastern Hitmen";

  result.innerHTML = '<div class="small">Loading schedule...</div>';

  try {
    const r = await fetch(`/api/schedule?team=${encodeURIComponent(tracked)}`);
    const d = await r.json();

    if (d.ok && d.schedule && d.schedule.length > 0) {
      let html = `<div class="small" style="margin:10px 0;">${d.games_found} games for ${d.team}</div>`;
      html += '<table><thead><tr><th>#</th><th>Matchup</th><th>Date/Time</th><th>Rink</th></tr></thead><tbody>';
      d.schedule.forEach((g, i) => {
        html += `<tr>
          <td>${g.game_num || (i+1)}</td>
          <td><b>${g.location} ${g.opponent}</b></td>
          <td class="small">${g.date}<br>${g.time}</td>
          <td class="small">${g.rink || '-'}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      result.innerHTML = html;
    } else {
      result.innerHTML = `<div class="small" style="margin-top:10px;">No schedule found for ${tracked}</div>`;
    }
  } catch (e) {
    result.innerHTML = `<div class="msg error">Error: ${e.message}</div>`;
  }
}

async function fetchScores() {
  const result = document.getElementById("scores-result");
  const tracked = document.getElementById("track-team").value || "Eastern Hitmen";
  const teamLower = tracked.toLowerCase();

  result.innerHTML = '<div class="small">Loading scores...</div>';

  try {
    const r = await fetch('/api/scores');
    const d = await r.json();

    if (d.ok && d.games && d.games.length > 0) {
      // Show ALL games, highlight tracked team's games
      let html = `<div class="small" style="margin:10px 0;">${d.games.length} completed game(s)</div>`;
      html += '<table><thead><tr><th>#</th><th>Home</th><th>Score</th><th>Away</th></tr></thead><tbody>';

      d.games.forEach((g, i) => {
        const isTrackedGame = g.home.toLowerCase().includes(teamLower) ||
                              g.away.toLowerCase().includes(teamLower) ||
                              (teamLower.includes('hitmen') && (g.home.toLowerCase().includes('hitmen') || g.away.toLowerCase().includes('hitmen'))) ||
                              (teamLower.includes('hitman') && (g.home.toLowerCase().includes('hitman') || g.away.toLowerCase().includes('hitman')));

        const rowClass = isTrackedGame ? 'class="hitmen"' : '';
        const otText = g.ot ? ' (OT)' : '';

        html += `<tr ${rowClass}>
          <td>${g.game_num || (i+1)}</td>
          <td>${g.home}</td>
          <td><b>${g.home_score} - ${g.away_score}</b>${otText}</td>
          <td>${g.away}</td>
        </tr>`;
      });

      html += '</tbody></table>';
      result.innerHTML = html;
    } else {
      result.innerHTML = '<div class="small" style="margin-top:10px;">No scores available yet</div>';
    }
  } catch (e) {
    result.innerHTML = `<div class="msg error">Error: ${e.message}</div>`;
  }
}

async function fetchAIAnalysis() {
  const result = document.getElementById("ai-result");
  const tracked = document.getElementById("track-team").value || "Eastern Hitmen";

  result.innerHTML = '<div class="msg info">Analyzing with AI... This may take a moment.</div>';

  try {
    const r = await fetch(`/api/ai-analysis?team=${encodeURIComponent(tracked)}`);
    const d = await r.json();

    if (d.ok && d.analysis) {
      let html = `<div style="margin-top:12px;padding:12px;background:#1a2538;border-radius:8px;font-size:14px;line-height:1.6;">`;
      // Convert markdown-style formatting to HTML
      const formatted = d.analysis
        .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n- /g, '<br>• ')
        .replace(/\n/g, '<br>');
      html += `<p>${formatted}</p>`;
      html += `</div>`;
      html += `<div class="small" style="margin-top:8px;">Analysis for: ${d.team} | Rank: #${d.rank || '?'}</div>`;
      result.innerHTML = html;
    } else {
      result.innerHTML = `<div class="msg error">${d.error || 'Failed to get AI analysis'}</div>`;
    }
  } catch (e) {
    result.innerHTML = `<div class="msg error">Error: ${e.message}</div>`;
  }
}

async function fetchPlayoffBracket() {
  const result = document.getElementById("bracket-result");
  const tracked = document.getElementById("track-team").value || "Eastern Hitmen";
  const trackedLower = tracked.toLowerCase();

  result.innerHTML = '<div class="msg info">Loading playoff bracket...</div>';

  try {
    const r = await fetch('/api/playoff-bracket');
    const d = await r.json();

    if (d.ok && d.bracket && d.bracket.length > 0) {
      let html = `<div class="small" style="margin:10px 0;">${d.teams_in_playoffs} teams qualify for playoffs (of ${d.teams_count} total)</div>`;

      // Round of 16 header
      html += '<div style="margin-top:12px;font-weight:600;color:#6366f1;font-size:13px;">Round of 16</div>';
      html += '<table style="margin-top:8px;"><thead><tr><th>Game</th><th>High Seed</th><th>vs</th><th>Low Seed</th></tr></thead><tbody>';

      d.bracket.forEach(m => {
        // Highlight row if tracked team is in this matchup
        const highTeam = m.high_seed ? m.high_seed.team : 'BYE';
        const lowTeam = m.low_seed ? m.low_seed.team : 'BYE';
        const isTrackedGame = highTeam.toLowerCase().includes(trackedLower) ||
                              lowTeam.toLowerCase().includes(trackedLower) ||
                              (trackedLower.includes('hitmen') && (highTeam.toLowerCase().includes('hitmen') || lowTeam.toLowerCase().includes('hitmen')));

        const rowClass = isTrackedGame ? 'class="hitmen"' : '';

        if (m.high_seed && m.low_seed) {
          html += `<tr ${rowClass}>
            <td style="color:#6366f1;font-weight:600;">${m.game}</td>
            <td><b>#${m.high_seed.rank}</b> ${m.high_seed.team}<br><span class="small">${m.high_seed.record} (${m.high_seed.pts}pts)</span></td>
            <td style="color:#9fb0cf;">vs</td>
            <td><b>#${m.low_seed.rank}</b> ${m.low_seed.team}<br><span class="small">${m.low_seed.record} (${m.low_seed.pts}pts)</span></td>
          </tr>`;
        } else if (m.high_seed) {
          html += `<tr ${rowClass}>
            <td style="color:#6366f1;font-weight:600;">${m.game}</td>
            <td><b>#${m.high_seed.rank}</b> ${m.high_seed.team}</td>
            <td colspan="2" style="color:#4ade80;">BYE - Advances</td>
          </tr>`;
        }
      });
      html += '</tbody></table>';

      // Link to full rules
      html += '<div class="small" style="margin-top:10px;"><a href="/rules" style="color:#4da3ff;">See full bracket & rules →</a></div>';

      result.innerHTML = html;
    } else {
      result.innerHTML = `<div class="msg error">${d.error || 'Could not load playoff bracket'}</div>`;
    }
  } catch (e) {
    result.innerHTML = `<div class="msg error">Error: ${e.message}</div>`;
  }
}

// Auto-fetch live standings on page load
fetchLive();
</script>
</body>
</html>
